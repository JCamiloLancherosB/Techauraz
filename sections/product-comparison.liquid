{% comment %}
  Product Comparison Section
  Displays a comparison table for selected products
  
  Features:
  - Comparison table with sticky header row
  - Support for 2-4 products side-by-side
  - Display: product image, title, price, key specifications
  - "Agregar al carrito" button for each product
  - "Quitar" (remove) button to remove from comparison
  - Empty state with instructions
  - Share comparison via URL
{% endcomment %}

{{ 'product-comparison.css' | asset_url | stylesheet_tag }}
<script src="{{ 'product-comparison.js' | asset_url }}" defer="defer"></script>

<div class="comparison-section color-{{ section.settings.color_scheme }} gradient">
  <div class="page-width section-{{ section.id }}-padding">
    
    {%- comment -%} Header {%- endcomment -%}
    <div class="comparison__header">
      <h1 class="comparison__title">
        {{ section.settings.heading | default: 'Comparar Productos' }}
      </h1>
      {%- if section.settings.subheading != blank -%}
        <p class="comparison__subtitle">{{ section.settings.subheading }}</p>
      {%- endif -%}
    </div>

    {%- comment -%} Comparison Table Container (JS will populate this) {%- endcomment -%}
    <div data-comparison-table-container>
      {%- comment -%} 
        Check if products are passed via URL parameters
        This enables server-side rendering for SEO and non-JS fallback
      {%- endcomment -%}
      {%- assign compare_handles = request.path | split: '?' | last | split: '&' -%}
      {%- assign product_handles = '' -%}
      {%- for param in compare_handles -%}
        {%- if param contains 'compare=' -%}
          {%- assign product_handles = param | remove: 'compare=' | url_decode -%}
        {%- endif -%}
      {%- endfor -%}
      
      {%- comment -%} Also check query string directly {%- endcomment -%}
      {%- if product_handles == blank -%}
        {%- assign product_handles = request.params.compare -%}
      {%- endif -%}

      {%- if product_handles != blank -%}
        {%- assign handles_array = product_handles | split: ',' -%}
        {%- assign comparison_products = '' | split: ',' -%}
        
        {%- for handle in handles_array limit: 4 -%}
          {%- assign trimmed_handle = handle | strip -%}
          {%- assign found_product = all_products[trimmed_handle] -%}
          {%- if found_product -%}
            {%- assign comparison_products = comparison_products | push: found_product -%}
          {%- endif -%}
        {%- endfor -%}

        {%- if comparison_products.size > 0 -%}
          {%- comment -%} Server-side rendered comparison table {%- endcomment -%}
          <div class="comparison-table-wrapper">
            <table class="comparison-table">
              <thead>
                <tr>
                  <th scope="col">{{ 'products.comparison.specification' | t | default: 'Especificación' }}</th>
                  {%- for product in comparison_products -%}
                    <th scope="col" class="comparison-table__product-col">
                      <div class="comparison-table__product-header">
                        <div class="comparison-table__product-image">
                          {%- if product.featured_media -%}
                            <img 
                              src="{{ product.featured_media | image_url: width: 240 }}"
                              alt="{{ product.featured_media.alt | escape | default: product.title | escape }}"
                              loading="lazy"
                              width="120"
                              height="120"
                            >
                          {%- else -%}
                            {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                          {%- endif -%}
                        </div>
                        <h3 class="comparison-table__product-title">
                          <a href="{{ product.url }}">{{ product.title }}</a>
                        </h3>
                        <div class="comparison-table__product-price">
                          {%- if product.compare_at_price > product.price -%}
                            <span class="comparison-table__price-compare">{{ product.compare_at_price | money }}</span>
                          {%- endif -%}
                          <span class="comparison-table__price-current">{{ product.price | money }}</span>
                        </div>
                        <div class="comparison-table__product-actions">
                          {%- if product.available -%}
                            <form method="post" action="{{ routes.cart_add_url }}">
                              <input type="hidden" name="form_type" value="product">
                              <input type="hidden" name="utf8" value="✓">
                              <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
                              <button type="submit" class="comparison-table__add-btn">
                                {{ 'products.product.add_to_cart' | t | default: 'Agregar al carrito' }}
                              </button>
                            </form>
                          {%- else -%}
                            <button type="button" class="comparison-table__add-btn" disabled>
                              {{ 'products.product.sold_out' | t | default: 'Agotado' }}
                            </button>
                          {%- endif -%}
                          <button type="button" class="comparison-table__remove-btn" data-table-remove="{{ product.handle }}">
                            {{ 'products.comparison.remove' | t | default: 'Quitar' }}
                          </button>
                        </div>
                      </div>
                    </th>
                  {%- endfor -%}
                </tr>
              </thead>
              <tbody>
                {%- comment -%} Price Row {%- endcomment -%}
                <tr>
                  <th scope="row">{{ 'products.comparison.price' | t | default: 'Precio' }}</th>
                  {%- for product in comparison_products -%}
                    <td>
                      <span class="comparison-table__spec-value">
                        {{ product.price | money }}
                        {%- if product.compare_at_price > product.price -%}
                          <br><small class="comparison-table__savings">
                            {{ 'products.comparison.save' | t | default: 'Ahorras' }}: 
                            {{ product.compare_at_price | minus: product.price | money }}
                          </small>
                        {%- endif -%}
                      </span>
                    </td>
                  {%- endfor -%}
                </tr>

                {%- comment -%} Availability Row {%- endcomment -%}
                <tr>
                  <th scope="row">{{ 'products.comparison.availability' | t | default: 'Disponibilidad' }}</th>
                  {%- for product in comparison_products -%}
                    <td>
                      {%- if product.available -%}
                        <span class="comparison-table__spec-value comparison-table__spec-value--highlight">
                          ✓ {{ 'products.product.in_stock' | t | default: 'En stock' }}
                        </span>
                      {%- else -%}
                        <span class="comparison-table__spec-value comparison-table__spec-value--na">
                          {{ 'products.product.sold_out' | t | default: 'Agotado' }}
                        </span>
                      {%- endif -%}
                    </td>
                  {%- endfor -%}
                </tr>

                {%- comment -%} Vendor Row {%- endcomment -%}
                <tr>
                  <th scope="row">{{ 'products.comparison.vendor' | t | default: 'Marca' }}</th>
                  {%- for product in comparison_products -%}
                    <td>
                      <span class="comparison-table__spec-value">
                        {{ product.vendor | default: '-' }}
                      </span>
                    </td>
                  {%- endfor -%}
                </tr>

                {%- comment -%} Type Row {%- endcomment -%}
                <tr>
                  <th scope="row">{{ 'products.comparison.type' | t | default: 'Tipo' }}</th>
                  {%- for product in comparison_products -%}
                    <td>
                      <span class="comparison-table__spec-value">
                        {{ product.type | default: '-' }}
                      </span>
                    </td>
                  {%- endfor -%}
                </tr>

                {%- comment -%} 
                  Specification Rows from Metafields
                  Checks for common spec metafields used in electronics
                {%- endcomment -%}
                
                {%- comment -%} Ports/Connections {%- endcomment -%}
                {%- assign has_ports = false -%}
                {%- for product in comparison_products -%}
                  {%- if product.metafields.specs.ports != blank -%}
                    {%- assign has_ports = true -%}
                    {%- break -%}
                  {%- endif -%}
                {%- endfor -%}
                {%- if has_ports -%}
                  <tr>
                    <th scope="row">{{ 'products.comparison.ports' | t | default: 'Puertos' }}</th>
                    {%- for product in comparison_products -%}
                      <td>
                        <span class="comparison-table__spec-value{% unless product.metafields.specs.ports %} comparison-table__spec-value--na{% endunless %}">
                          {{ product.metafields.specs.ports | default: '-' }}
                        </span>
                      </td>
                    {%- endfor -%}
                  </tr>
                {%- endif -%}

                {%- comment -%} Capacity/Storage {%- endcomment -%}
                {%- assign has_capacity = false -%}
                {%- for product in comparison_products -%}
                  {%- if product.metafields.specs.capacity != blank -%}
                    {%- assign has_capacity = true -%}
                    {%- break -%}
                  {%- endif -%}
                {%- endfor -%}
                {%- if has_capacity -%}
                  <tr>
                    <th scope="row">{{ 'products.comparison.capacity' | t | default: 'Capacidad' }}</th>
                    {%- for product in comparison_products -%}
                      <td>
                        <span class="comparison-table__spec-value{% unless product.metafields.specs.capacity %} comparison-table__spec-value--na{% endunless %}">
                          {{ product.metafields.specs.capacity | default: '-' }}
                        </span>
                      </td>
                    {%- endfor -%}
                  </tr>
                {%- endif -%}

                {%- comment -%} Connectivity {%- endcomment -%}
                {%- assign has_connectivity = false -%}
                {%- for product in comparison_products -%}
                  {%- if product.metafields.specs.connectivity != blank -%}
                    {%- assign has_connectivity = true -%}
                    {%- break -%}
                  {%- endif -%}
                {%- endfor -%}
                {%- if has_connectivity -%}
                  <tr>
                    <th scope="row">{{ 'products.comparison.connectivity' | t | default: 'Conectividad' }}</th>
                    {%- for product in comparison_products -%}
                      <td>
                        <span class="comparison-table__spec-value{% unless product.metafields.specs.connectivity %} comparison-table__spec-value--na{% endunless %}">
                          {{ product.metafields.specs.connectivity | default: '-' }}
                        </span>
                      </td>
                    {%- endfor -%}
                  </tr>
                {%- endif -%}

                {%- comment -%} Battery {%- endcomment -%}
                {%- assign has_battery = false -%}
                {%- for product in comparison_products -%}
                  {%- if product.metafields.specs.battery != blank -%}
                    {%- assign has_battery = true -%}
                    {%- break -%}
                  {%- endif -%}
                {%- endfor -%}
                {%- if has_battery -%}
                  <tr>
                    <th scope="row">{{ 'products.comparison.battery' | t | default: 'Batería' }}</th>
                    {%- for product in comparison_products -%}
                      <td>
                        <span class="comparison-table__spec-value{% unless product.metafields.specs.battery %} comparison-table__spec-value--na{% endunless %}">
                          {{ product.metafields.specs.battery | default: '-' }}
                        </span>
                      </td>
                    {%- endfor -%}
                  </tr>
                {%- endif -%}

                {%- comment -%} Dimensions {%- endcomment -%}
                {%- assign has_dimensions = false -%}
                {%- for product in comparison_products -%}
                  {%- if product.metafields.specs.dimensions != blank -%}
                    {%- assign has_dimensions = true -%}
                    {%- break -%}
                  {%- endif -%}
                {%- endfor -%}
                {%- if has_dimensions -%}
                  <tr>
                    <th scope="row">{{ 'products.comparison.dimensions' | t | default: 'Dimensiones' }}</th>
                    {%- for product in comparison_products -%}
                      <td>
                        <span class="comparison-table__spec-value{% unless product.metafields.specs.dimensions %} comparison-table__spec-value--na{% endunless %}">
                          {{ product.metafields.specs.dimensions | default: '-' }}
                        </span>
                      </td>
                    {%- endfor -%}
                  </tr>
                {%- endif -%}

                {%- comment -%} Weight {%- endcomment -%}
                {%- assign has_weight = false -%}
                {%- for product in comparison_products -%}
                  {%- if product.metafields.specs.weight != blank -%}
                    {%- assign has_weight = true -%}
                    {%- break -%}
                  {%- endif -%}
                {%- endfor -%}
                {%- if has_weight -%}
                  <tr>
                    <th scope="row">{{ 'products.comparison.weight' | t | default: 'Peso' }}</th>
                    {%- for product in comparison_products -%}
                      <td>
                        <span class="comparison-table__spec-value{% unless product.metafields.specs.weight %} comparison-table__spec-value--na{% endunless %}">
                          {{ product.metafields.specs.weight | default: '-' }}
                        </span>
                      </td>
                    {%- endfor -%}
                  </tr>
                {%- endif -%}

                {%- comment -%} Warranty {%- endcomment -%}
                {%- assign has_warranty = false -%}
                {%- for product in comparison_products -%}
                  {%- if product.metafields.specs.warranty != blank -%}
                    {%- assign has_warranty = true -%}
                    {%- break -%}
                  {%- endif -%}
                {%- endfor -%}
                {%- if has_warranty -%}
                  <tr>
                    <th scope="row">{{ 'products.comparison.warranty' | t | default: 'Garantía' }}</th>
                    {%- for product in comparison_products -%}
                      <td>
                        <span class="comparison-table__spec-value{% unless product.metafields.specs.warranty %} comparison-table__spec-value--na{% endunless %}">
                          {{ product.metafields.specs.warranty | default: '-' }}
                        </span>
                      </td>
                    {%- endfor -%}
                  </tr>
                {%- endif -%}

                {%- comment -%} Description Row {%- endcomment -%}
                <tr>
                  <th scope="row">{{ 'products.comparison.description' | t | default: 'Descripción' }}</th>
                  {%- for product in comparison_products -%}
                    <td>
                      <span class="comparison-table__spec-value">
                        {{ product.description | strip_html | truncatewords: 25 | default: '-' }}
                      </span>
                    </td>
                  {%- endfor -%}
                </tr>
              </tbody>
            </table>
          </div>

          {%- comment -%} Share Section {%- endcomment -%}
          <div class="comparison__share">
            <span class="comparison__share-label">{{ 'products.comparison.share_comparison' | t | default: 'Compartir comparación:' }}</span>
            <button type="button" class="comparison__share-btn" data-comparison-share aria-label="{{ 'products.comparison.copy_link' | t | default: 'Copiar enlace' }}">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
              </svg>
              {{ 'products.comparison.copy_link' | t | default: 'Copiar enlace' }}
            </button>
          </div>

        {%- else -%}
          {%- comment -%} No valid products found from URL {%- endcomment -%}
          <div class="comparison__empty" data-comparison-empty>
            <div class="comparison__empty-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="20" x2="18" y2="10"></line>
                <line x1="12" y1="20" x2="12" y2="4"></line>
                <line x1="6" y1="20" x2="6" y2="14"></line>
              </svg>
            </div>
            <h2 class="comparison__empty-title">
              {{ 'products.comparison.empty_title' | t | default: 'No hay productos para comparar' }}
            </h2>
            <p class="comparison__empty-text">
              {{ 'products.comparison.empty_text' | t | default: 'Agrega productos a la comparación desde las tarjetas de producto usando el botón "Comparar".' }}
            </p>
            <a href="{{ routes.collections_url }}" class="comparison__empty-btn">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
              </svg>
              {{ 'products.comparison.browse_products' | t | default: 'Explorar productos' }}
            </a>
          </div>
        {%- endif -%}
        
      {%- else -%}
        {%- comment -%} Empty State - No products to compare {%- endcomment -%}
        <div class="comparison__empty" data-comparison-empty>
          <div class="comparison__empty-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="20" x2="18" y2="10"></line>
              <line x1="12" y1="20" x2="12" y2="4"></line>
              <line x1="6" y1="20" x2="6" y2="14"></line>
            </svg>
          </div>
          <h2 class="comparison__empty-title">
            {{ 'products.comparison.empty_title' | t | default: 'No hay productos para comparar' }}
          </h2>
          <p class="comparison__empty-text">
            {{ 'products.comparison.empty_text' | t | default: 'Agrega productos a la comparación desde las tarjetas de producto usando el botón "Comparar".' }}
          </p>
          <a href="{{ routes.collections_url }}" class="comparison__empty-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
            {{ 'products.comparison.browse_products' | t | default: 'Explorar productos' }}
          </a>
        </div>
      {%- endif -%}
    </div>

  </div>
</div>

{%- comment -%} JavaScript for dynamic table rendering {%- endcomment -%}
<script>
  window.renderComparisonTable = function(products) {
    const container = document.querySelector('[data-comparison-table-container]');
    if (!container) return;

    if (!products || products.length === 0) {
      container.innerHTML = `
        <div class="comparison__empty" data-comparison-empty>
          <div class="comparison__empty-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="20" x2="18" y2="10"></line>
              <line x1="12" y1="20" x2="12" y2="4"></line>
              <line x1="6" y1="20" x2="6" y2="14"></line>
            </svg>
          </div>
          <h2 class="comparison__empty-title">
            {{ 'products.comparison.empty_title' | t | default: 'No hay productos para comparar' | json }}
          </h2>
          <p class="comparison__empty-text">
            {{ 'products.comparison.empty_text' | t | default: 'Agrega productos a la comparación desde las tarjetas de producto usando el botón Comparar.' | json }}
          </p>
          <a href="{{ routes.collections_url }}" class="comparison__empty-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
            {{ 'products.comparison.browse_products' | t | default: 'Explorar productos' | json }}
          </a>
        </div>
      `;
      return;
    }

    // For dynamic updates, we reload the page with URL params
    // This ensures server-side rendering for SEO
    const handles = products.map(p => p.handle).join(',');
    const currentParams = new URLSearchParams(window.location.search);
    const currentCompare = currentParams.get('compare');
    
    if (currentCompare !== handles) {
      currentParams.set('compare', handles);
      window.history.replaceState({}, '', '?' + currentParams.toString());
      window.location.reload();
    }
  };
</script>

{% schema %}
{
  "name": "Comparación de Productos",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Título",
      "default": "Comparar Productos"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subtítulo",
      "default": "Compara las especificaciones de tus productos favoritos"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Esquema de color",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "Espaciado de sección"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Espaciado superior",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Espaciado inferior",
      "default": 36
    }
  ],
  "presets": [
    {
      "name": "Comparación de Productos",
      "category": "Productos"
    }
  ]
}
{% endschema %}
