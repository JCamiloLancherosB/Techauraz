{{ 'product-page-consolidated.css' | asset_url | stylesheet_tag }}

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }
{%- endstyle -%}

<div class="product-testimonials section-{{ section.id }}-padding">
  <div class="product-testimonials__container page-width">
    {% if section.settings.heading != blank %}
      <h2 class="product-testimonials__heading">{{ section.settings.heading }}</h2>
    {% endif %}
    
    <div class="product-testimonials__carousel" data-testimonials-carousel>
      <div class="product-testimonials__track" data-testimonials-track>
        {% if section.blocks.size > 0 %}
          {% for block in section.blocks %}
            <div class="product-testimonials__slide" {{ block.shopify_attributes }}>
              <div class="product-testimonials__card">
                <div class="product-testimonials__stars" aria-label="Calificación: {{ block.settings.rating }} de 5 estrellas">
                  {% for i in (1..5) %}
                    {% if i <= block.settings.rating %}
                      <span class="star-filled">⭐</span>
                    {% else %}
                      <span class="star-empty">☆</span>
                    {% endif %}
                  {% endfor %}
                </div>
                <p class="product-testimonials__text">{{ block.settings.testimonial }}</p>
                <div class="product-testimonials__author">
                  <div class="product-testimonials__avatar">
                    {% if block.settings.avatar != blank %}
                      {{ block.settings.avatar | image_url: width: 60 | image_tag: loading: 'lazy', alt: block.settings.customer_name }}
                    {% else %}
                      <svg width="60" height="60" viewBox="0 0 60 60" fill="none">
                        <circle cx="30" cy="30" r="30" fill="#f97316"/>
                        <path d="M30 30c4.95 0 9-4.05 9-9s-4.05-9-9-9-9 4.05-9 9 4.05 9 9 9zm0 4.5c-6 0-18 3-18 9v4.5h36v-4.5c0-6-12-9-18-9z" fill="white"/>
                      </svg>
                    {% endif %}
                  </div>
                  <div class="product-testimonials__author-info">
                    <strong class="product-testimonials__name">{{ block.settings.customer_name }}</strong>
                    {% if block.settings.customer_location != blank %}
                      <span class="product-testimonials__location">{{ block.settings.customer_location }}</span>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          {%- comment -%} Testimonios por defecto {%- endcomment -%}
          <div class="product-testimonials__slide">
            <div class="product-testimonials__card">
              <div class="product-testimonials__stars">⭐⭐⭐⭐⭐</div>
              <p class="product-testimonials__text">"Excelente producto, superó mis expectativas. La calidad es increíble y el envío fue muy rápido. ¡Totalmente recomendado!"</p>
              <div class="product-testimonials__author">
                <div class="product-testimonials__avatar">
                  <svg width="60" height="60" viewBox="0 0 60 60" fill="none">
                    <circle cx="30" cy="30" r="30" fill="#f97316"/>
                    <path d="M30 30c4.95 0 9-4.05 9-9s-4.05-9-9-9-9 4.05-9 9 4.05 9 9 9zm0 4.5c-6 0-18 3-18 9v4.5h36v-4.5c0-6-12-9-18-9z" fill="white"/>
                  </svg>
                </div>
                <div class="product-testimonials__author-info">
                  <strong class="product-testimonials__name">María González</strong>
                  <span class="product-testimonials__location">Bogotá</span>
                </div>
              </div>
            </div>
          </div>
        {% endif %}
      </div>
      
      {% if section.blocks.size > 1 %}
        <div class="product-testimonials__dots" data-testimonials-dots></div>
      {% endif %}
    </div>
  </div>
</div>

<script>
(function() {
  class TestimonialsCarousel {
    constructor(element) {
      this.carousel = element;
      this.track = element.querySelector('[data-testimonials-track]');
      this.slides = Array.from(this.track.children);
      this.dotsContainer = element.querySelector('[data-testimonials-dots]');
      this.currentIndex = 0;
      this.autoplayInterval = null;

      if (this.slides.length > 1) {
        this.createDots();
        this.startAutoplay();
        this.setupTouchEvents();
      }
    }

    createDots() {
      if (!this.dotsContainer) return;
      
      this.slides.forEach((_, index) => {
        const dot = document.createElement('button');
        dot.classList.add('product-testimonials__dot');
        dot.setAttribute('aria-label', `Ir al testimonio ${index + 1}`);
        if (index === 0) dot.classList.add('active');
        dot.addEventListener('click', () => this.goToSlide(index));
        this.dotsContainer.appendChild(dot);
      });
      this.dots = Array.from(this.dotsContainer.children);
    }

    goToSlide(index) {
      if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
        this.track.style.transition = 'none';
      }
      
      this.currentIndex = index;
      this.track.style.transform = `translateX(-${index * 100}%)`;
      
      if (this.dots) {
        this.dots.forEach((dot, i) => {
          dot.classList.toggle('active', i === index);
        });
      }
    }

    startAutoplay() {
      if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
      
      this.autoplayInterval = setInterval(() => {
        const nextIndex = (this.currentIndex + 1) % this.slides.length;
        this.goToSlide(nextIndex);
      }, 5000);

      // Pausar en hover
      this.carousel.addEventListener('mouseenter', () => {
        clearInterval(this.autoplayInterval);
      });

      this.carousel.addEventListener('mouseleave', () => {
        if (!this.autoplayInterval) {
          this.startAutoplay();
        }
      });
    }

    setupTouchEvents() {
      let startX = 0;
      let currentX = 0;

      this.track.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
      });

      this.track.addEventListener('touchmove', (e) => {
        currentX = e.touches[0].clientX;
      });

      this.track.addEventListener('touchend', () => {
        const diff = startX - currentX;
        if (Math.abs(diff) > 50) {
          if (diff > 0 && this.currentIndex < this.slides.length - 1) {
            this.goToSlide(this.currentIndex + 1);
          } else if (diff < 0 && this.currentIndex > 0) {
            this.goToSlide(this.currentIndex - 1);
          }
        }
      });
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const carousels = document.querySelectorAll('[data-testimonials-carousel]');
    carousels.forEach(carousel => new TestimonialsCarousel(carousel));
  });
})();
</script>

{% schema %}
{
  "name": "Carrusel de Testimonios",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Encabezado",
      "default": "Lo que dicen nuestros clientes"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Espaciado superior",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Espaciado inferior",
      "default": 36
    }
  ],
  "blocks": [
    {
      "type": "testimonial",
      "name": "Testimonio",
      "settings": [
        {
          "type": "range",
          "id": "rating",
          "min": 1,
          "max": 5,
          "step": 1,
          "label": "Calificación (estrellas)",
          "default": 5
        },
        {
          "type": "textarea",
          "id": "testimonial",
          "label": "Testimonio",
          "default": "Excelente producto, totalmente recomendado."
        },
        {
          "type": "text",
          "id": "customer_name",
          "label": "Nombre del cliente",
          "default": "Cliente satisfecho"
        },
        {
          "type": "text",
          "id": "customer_location",
          "label": "Ubicación del cliente",
          "default": "Colombia"
        },
        {
          "type": "image_picker",
          "id": "avatar",
          "label": "Foto del cliente (opcional)"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Carrusel de Testimonios",
      "blocks": [
        {
          "type": "testimonial",
          "settings": {
            "rating": 5,
            "testimonial": "Excelente producto, superó mis expectativas. La calidad es increíble y el envío fue muy rápido.",
            "customer_name": "María González",
            "customer_location": "Bogotá"
          }
        },
        {
          "type": "testimonial",
          "settings": {
            "rating": 5,
            "testimonial": "Muy recomendado, el mejor producto que he comprado. Llegó en perfectas condiciones.",
            "customer_name": "Carlos Ramírez",
            "customer_location": "Medellín"
          }
        },
        {
          "type": "testimonial",
          "settings": {
            "rating": 4,
            "testimonial": "Buena calidad y precio justo. El servicio al cliente fue excelente.",
            "customer_name": "Ana Torres",
            "customer_location": "Cali"
          }
        }
      ]
    }
  ]
}
{% endschema %}
