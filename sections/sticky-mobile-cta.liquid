{%- if section.settings.enable_sticky_cta and product -%}
<div 
  class="sticky-cta-bar" 
  data-sticky-cta
  role="region"
  aria-label="Botones de compra rápida"
>
  <div class="sticky-cta-bar__container">
    <div class="sticky-cta-bar__price" data-sticky-price>
      {%- if product.selected_or_first_available_variant.compare_at_price > product.selected_or_first_available_variant.price -%}
        <span class="sticky-cta-bar__price-sale">{{ product.selected_or_first_available_variant.price | money }}</span>
        <span class="sticky-cta-bar__price-compare">{{ product.selected_or_first_available_variant.compare_at_price | money }}</span>
      {%- else -%}
        <span class="sticky-cta-bar__price-regular">{{ product.selected_or_first_available_variant.price | money }}</span>
      {%- endif -%}
    </div>
    <button
      type="button"
      class="sticky-cta-bar__button sticky-cta-bar__button--buy"
      data-sticky-buy
      aria-label="Agregar {{ product.title }}"
    >
      <svg class="sticky-cta-bar__icon" width="20" height="20" viewBox="0 0 20 20" fill="none" aria-hidden="true">
        <path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 002-1.61L19 6H5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="9" cy="18" r="1" fill="currentColor"/>
        <circle cx="16" cy="18" r="1" fill="currentColor"/>
      </svg>
      <span class="sticky-cta-bar__text">{{ section.settings.buy_button_text | default: 'Agregar' }}</span>
    </button>
  </div>
</div>

<script>
  class StickyCTABar {
    constructor(element) {
      this.element = element;
      this.buyButton = element.querySelector('[data-sticky-buy]');
      this.productForm = document.querySelector('product-form');
      this.submitButton = document.querySelector('.product-form__submit[id^="ProductSubmitButton-"]') ||
                          document.querySelector('[id^="ProductSubmitButton-"]') ||
                          document.querySelector('[name="add"]');
      this.priceContainer = element.querySelector('[data-sticky-price]');
      this.handleVariantChange = this.handleVariantChange.bind(this);
      
      this.init();
    }

    init() {
      // Show/hide based on scroll position
      this.handleScroll();
      window.addEventListener('scroll', () => this.handleScroll(), { passive: true });
      
      // Handle buy button click
      if (this.buyButton && this.submitButton) {
        this.buyButton.addEventListener('click', () => {
          this.submitButton.click();
        });
      }

      document.addEventListener('variant:change', this.handleVariantChange);
      window.addEventListener('pagehide', () => this.destroy());
    }

    destroy() {
      document.removeEventListener('variant:change', this.handleVariantChange);
    }

    handleVariantChange(event) {
      if (!event.detail || !event.detail.variant || !this.priceContainer) {
        return;
      }

      const { price, compare_at_price: compareAtPrice } = event.detail.variant;
      this.priceContainer.innerHTML = '';

      if (compareAtPrice && compareAtPrice > price) {
        const salePriceSpan = document.createElement('span');
        salePriceSpan.className = 'sticky-cta-bar__price-sale';
        salePriceSpan.textContent = this.formatMoney(price);

        const comparePriceSpan = document.createElement('span');
        comparePriceSpan.className = 'sticky-cta-bar__price-compare';
        comparePriceSpan.textContent = this.formatMoney(compareAtPrice);

        this.priceContainer.appendChild(salePriceSpan);
        this.priceContainer.appendChild(comparePriceSpan);
      } else {
        const regularPriceSpan = document.createElement('span');
        regularPriceSpan.className = 'sticky-cta-bar__price-regular';
        regularPriceSpan.textContent = this.formatMoney(price);

        this.priceContainer.appendChild(regularPriceSpan);
      }
    }

    formatMoney(priceValue) {
      if (typeof priceValue === 'number') {
        if (typeof Shopify !== 'undefined' && typeof Shopify.formatMoney === 'function') {
          return Shopify.formatMoney(priceValue);
        }

        const currency = (typeof Shopify !== 'undefined' && Shopify.currency && Shopify.currency.active)
          ? Shopify.currency.active
          : 'COP';
        const locale = 'es-CO';

        return new Intl.NumberFormat(locale, {
          style: 'currency',
          currency: currency,
          minimumFractionDigits: 0,
          maximumFractionDigits: 0
        }).format(priceValue / 100);
      }

      return priceValue;
    }

    handleScroll() {
      const scrollPosition = window.scrollY;
      const mainButton = this.submitButton;
      const footer = document.querySelector('footer');
      const footerRect = footer ? footer.getBoundingClientRect() : null;
      const footerVisible = footerRect ? footerRect.top < window.innerHeight : false;
      const mainButtonVisible = mainButton
        ? mainButton.getBoundingClientRect().top < window.innerHeight && mainButton.getBoundingClientRect().bottom > 0
        : false;

      if (footerVisible || (mainButton && mainButtonVisible) || scrollPosition <= 200) {
        this.element.classList.remove('sticky-cta-bar--visible');
        return;
      }

      this.element.classList.add('sticky-cta-bar--visible');
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const stickyBar = document.querySelector('[data-sticky-cta]');
    if (stickyBar && window.innerWidth < 750) {
      new StickyCTABar(stickyBar);
    }
  });
</script>

<style>
  .sticky-cta-bar {
    position: fixed;
    bottom: 72px; /* Positioned to avoid WhatsApp (bottom: 15-20px) and cookie banner */
    left: 0;
    right: 0;
    z-index: 996; /* Below cookie (998) and WhatsApp (997) */
    background: white;
    box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.1);
    transform: translateY(120%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: none;
  }

  .sticky-cta-bar--visible {
    transform: translateY(0);
  }

  .sticky-cta-bar__container {
    display: grid;
    grid-template-columns: auto 1fr;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    max-width: 100%;
  }

  .sticky-cta-bar__price {
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 700;
    font-size: 1rem;
    color: #111827;
  }

  .sticky-cta-bar__price-sale {
    color: #f59e0b;
  }

  .sticky-cta-bar__price-regular {
    color: #111827;
  }

  .sticky-cta-bar__price-compare {
    font-size: 0.85rem;
    color: #9ca3af;
    text-decoration: line-through;
  }

  .sticky-cta-bar__button {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 16px;
    border: none;
    border-radius: 8px;
    font-size: 0.95rem;
    font-weight: 600;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
  }

  .sticky-cta-bar__icon {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
  }

  .sticky-cta-bar__text {
    display: inline-block;
  }

  .sticky-cta-bar__button--buy {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
  }

  .sticky-cta-bar__button:focus-visible {
    outline: 3px solid currentColor;
    outline-offset: 2px;
  }

  .sticky-cta-bar__button--buy:hover,
  .sticky-cta-bar__button--buy:active {
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
  }

  /* Show only on mobile */
  @media screen and (max-width: 749px) {
    .sticky-cta-bar {
      display: block;
    }
  }

  /* Larger mobile screens */
  @media screen and (min-width: 480px) and (max-width: 749px) {
    .sticky-cta-bar__container {
      padding: 12px 16px;
      gap: 16px;
    }
    
    .sticky-cta-bar__button {
      padding: 14px 20px;
      font-size: 1rem;
    }
  }

  @media screen and (max-width: 360px) {
    .sticky-cta-bar__price {
      font-size: 0.9rem;
    }

    .sticky-cta-bar__price-compare {
      font-size: 0.75rem;
    }

    .sticky-cta-bar__button {
      padding: 10px 12px;
      font-size: 0.9rem;
    }
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .sticky-cta-bar {
      transition: none;
    }
  }

  /* Safe area for devices with notch */
  @supports (padding: max(0px)) {
    .sticky-cta-bar {
      bottom: max(72px, calc(env(safe-area-inset-bottom) + 52px));
    }
  }
</style>
{%- endif -%}

{% schema %}
{
  "name": "Barra CTA Sticky Mobile",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "checkbox",
      "id": "enable_sticky_cta",
      "label": "Activar barra sticky",
      "default": true,
      "info": "Muestra botones fijos de compra y WhatsApp en móvil"
    },
    {
      "type": "text",
      "id": "buy_button_text",
      "label": "Texto botón comprar",
      "default": "Comprar ahora"
    },
    {
      "type": "text",
      "id": "whatsapp_phone",
      "label": "Número de WhatsApp",
      "default": "+573008602789",
      "info": "Número de WhatsApp con código de país (ejemplo: +573008602789)"
    },
    {
      "type": "text",
      "id": "whatsapp_button_text",
      "label": "Texto botón WhatsApp",
      "default": "WhatsApp"
    }
  ],
  "presets": [
    {
      "name": "Barra CTA Sticky Mobile"
    }
  ]
}
{% endschema %}
