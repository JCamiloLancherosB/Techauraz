{%- if section.settings.enable_sticky_cta and product -%}
<div 
  class="sticky-cta-bar" 
  data-sticky-cta
  role="region"
  aria-label="Botones de compra rápida"
  aria-hidden="true"
>
  {%- comment -%} Inline benefits bar - visible above CTA on mobile {%- endcomment -%}
  {%- if section.settings.show_benefits -%}
    <div class="sticky-cta-bar__benefits">
      <span class="sticky-cta-bar__benefit">
        <svg class="sticky-cta-bar__benefit-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M5 18H19V20H5V18ZM12 2L12.39 2.03C15.19 2.24 17.51 3.94 18.5 6.31L21 12L18.5 12V16H5.5V12L3 12L5.5 6.31C6.49 3.94 8.81 2.24 11.61 2.03L12 2Z" fill="currentColor"/>
          <path d="M12 4C9.79 4 7.96 5.56 7.18 7.71L6 10.5H18L16.82 7.71C16.04 5.56 14.21 4 12 4Z" fill="currentColor"/>
        </svg>
        <span>{{ section.settings.benefit_1_text | default: 'Envío Gratis' }}</span>
      </span>
      <span class="sticky-cta-bar__benefit-divider" aria-hidden="true">•</span>
      <span class="sticky-cta-bar__benefit">
        <svg class="sticky-cta-bar__benefit-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-2.22-1.87-1.5 0-2.4.68-2.4 1.64 0 .84.65 1.39 2.67 1.91s4.18 1.39 4.18 3.91c-.01 1.83-1.38 2.83-3.12 3.16z" fill="currentColor"/>
        </svg>
        <span>{{ section.settings.benefit_2_text | default: 'Pago Contraentrega' }}</span>
      </span>
    </div>
  {%- endif -%}
  
  <div class="sticky-cta-bar__container">
    <div class="sticky-cta-bar__info">
      <div class="sticky-cta-bar__price" data-sticky-price>
        {%- if product.selected_or_first_available_variant.compare_at_price > product.selected_or_first_available_variant.price -%}
          <span class="sticky-cta-bar__price-sale">{{ product.selected_or_first_available_variant.price | money }}</span>
          <span class="sticky-cta-bar__price-compare">{{ product.selected_or_first_available_variant.compare_at_price | money }}</span>
        {%- else -%}
          <span class="sticky-cta-bar__price-regular">{{ product.selected_or_first_available_variant.price | money }}</span>
        {%- endif -%}
      </div>
    </div>
    <button
      type="button"
      class="sticky-cta-bar__button sticky-cta-bar__button--buy"
      data-sticky-buy
      data-action="buy-now"
      {%- if product.selected_or_first_available_variant.available == false -%}
        disabled
        aria-disabled="true"
      {%- endif -%}
      aria-label="{% if product.selected_or_first_available_variant.available %}Comprar {{ product.title }} ahora{% else %}Producto agotado{% endif %}"
    >
      <svg class="sticky-cta-bar__icon" width="20" height="20" viewBox="0 0 20 20" fill="none" aria-hidden="true">
        <path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 002-1.61L19 6H5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="9" cy="18" r="1" fill="currentColor"/>
        <circle cx="16" cy="18" r="1" fill="currentColor"/>
      </svg>
      <span class="sticky-cta-bar__text">
        {%- if product.selected_or_first_available_variant.available == false -%}
          Agotado
        {%- else -%}
          {{ section.settings.buy_button_text | default: 'Comprar ahora' }}
        {%- endif -%}
      </span>
    </button>
  </div>
</div>

{%- comment -%} 
  Styles have been moved to assets/techauraz-custom-ui.css
  for maintainability and predictable cascade.
{%- endcomment -%}

<script>
  /**
   * StickyCTABar Class
   * - Shows when primary CTA scrolls out of viewport
   * - Coordinates with WhatsApp and cookie banner
   * - Handles Buy Now vs Add to Cart action intentionally
   * - Updates on variant changes
   */
  class StickyCTABar {
    constructor(element) {
      this.element = element;
      this.buyButton = element.querySelector('[data-sticky-buy]');
      this.priceContainer = element.querySelector('[data-sticky-price]');
      this.handleVariantChange = this.handleVariantChange.bind(this);
      this.handleScroll = this.handleScroll.bind(this);
      
      // Find primary CTA elements - multiple fallback selectors
      this.submitButton = this.findPrimaryButton();
      this.buyNowButton = this.findBuyNowButton();
      
      this.init();
    }
    
    findPrimaryButton() {
      const selectors = [
        '.product-form__submit[id^="ProductSubmitButton-"]',
        '[id^="ProductSubmitButton-"]',
        '.product-form__submit',
        '[name="add"]'
      ];
      
      for (const selector of selectors) {
        const button = document.querySelector(selector);
        if (button) return button;
      }
      return null;
    }
    
    findBuyNowButton() {
      return document.querySelector('.shopify-payment-button__button') ||
             document.querySelector('.tech-cta-primary .shopify-payment-button__button');
    }

    init() {
      // Only activate on mobile
      if (window.innerWidth >= 750) {
        this.element.style.display = 'none';
        return;
      }
      
      // Show/hide based on scroll position
      this.handleScroll();
      window.addEventListener('scroll', this.handleScroll, { passive: true });
      
      // Handle buy button click - triggers Buy Now by default
      if (this.buyButton) {
        this.buyButton.addEventListener('click', (e) => {
          e.preventDefault();
          this.handleBuyClick();
        });
      }

      document.addEventListener('variant:change', this.handleVariantChange);
      
      // Handle resize
      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          if (window.innerWidth >= 750) {
            this.hideStickyBar();
          } else {
            this.handleScroll();
          }
        }, 150);
      });
      
      window.addEventListener('pagehide', () => this.destroy());
    }
    
    handleBuyClick() {
      const action = this.buyButton.dataset.action || 'buy-now';
      let targetButton;
      
      if (action === 'buy-now') {
        // Try Buy Now (accelerated checkout) first
        targetButton = this.buyNowButton || this.submitButton;
      } else {
        // Add to Cart action
        targetButton = this.submitButton;
      }
      
      if (targetButton && typeof targetButton.click === 'function') {
        // Scroll to product form for user context
        const productForm = document.querySelector('product-form, .product-form');
        if (productForm) {
          productForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        // Small delay to allow scroll before triggering action
        setTimeout(() => {
          targetButton.click();
        }, 100);
      } else {
        console.error('Sticky CTA: No valid target button found');
      }
    }

    destroy() {
      document.removeEventListener('variant:change', this.handleVariantChange);
      window.removeEventListener('scroll', this.handleScroll);
    }

    handleVariantChange(event) {
      if (!event.detail || !event.detail.variant) return;
      
      const variant = event.detail.variant;
      
      // Update price display
      if (this.priceContainer && variant.price !== undefined) {
        this.updatePriceDisplay(variant.price, variant.compare_at_price);
      }
      
      // Update button state
      if (this.buyButton) {
        this.updateButtonState(variant.available);
      }
    }
    
    updatePriceDisplay(price, compareAtPrice) {
      this.priceContainer.innerHTML = '';

      if (compareAtPrice && compareAtPrice > price) {
        const salePriceSpan = document.createElement('span');
        salePriceSpan.className = 'sticky-cta-bar__price-sale';
        salePriceSpan.textContent = this.formatMoney(price);

        const comparePriceSpan = document.createElement('span');
        comparePriceSpan.className = 'sticky-cta-bar__price-compare';
        comparePriceSpan.textContent = this.formatMoney(compareAtPrice);

        this.priceContainer.appendChild(salePriceSpan);
        this.priceContainer.appendChild(comparePriceSpan);
      } else {
        const regularPriceSpan = document.createElement('span');
        regularPriceSpan.className = 'sticky-cta-bar__price-regular';
        regularPriceSpan.textContent = this.formatMoney(price);

        this.priceContainer.appendChild(regularPriceSpan);
      }
    }
    
    updateButtonState(isAvailable) {
      const textSpan = this.buyButton.querySelector('.sticky-cta-bar__text');
      
      if (isAvailable) {
        this.buyButton.disabled = false;
        this.buyButton.removeAttribute('aria-disabled');
        if (textSpan) textSpan.textContent = '{{ section.settings.buy_button_text | default: "Comprar ahora" }}';
        this.buyButton.setAttribute('aria-label', 'Comprar ahora');
      } else {
        this.buyButton.disabled = true;
        this.buyButton.setAttribute('aria-disabled', 'true');
        if (textSpan) textSpan.textContent = 'Agotado';
        this.buyButton.setAttribute('aria-label', 'Producto agotado');
      }
    }

    formatMoney(priceValue) {
      if (typeof priceValue === 'number') {
        try {
          if (typeof Shopify !== 'undefined' && typeof Shopify.formatMoney === 'function') {
            return Shopify.formatMoney(priceValue);
          }
        } catch (e) {
          console.warn('Shopify.formatMoney failed, using fallback', e);
        }

        const currency = (typeof Shopify !== 'undefined' && Shopify.currency && Shopify.currency.active)
          ? Shopify.currency.active
          : 'COP';
        const locale = 'es-CO';

        try {
          return new Intl.NumberFormat(locale, {
            style: 'currency',
            currency: currency,
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
          }).format(priceValue / 100);
        } catch (e) {
          return '$' + Math.round(priceValue / 100).toLocaleString();
        }
      }

      return priceValue;
    }

    handleScroll() {
      if (window.innerWidth >= 750) {
        this.hideStickyBar();
        return;
      }
      
      const scrollPosition = window.scrollY;
      const mainButton = this.submitButton;
      const footer = document.querySelector('footer');
      const footerRect = footer ? footer.getBoundingClientRect() : null;
      const footerVisible = footerRect ? footerRect.top < window.innerHeight : false;
      const mainButtonVisible = mainButton
        ? mainButton.getBoundingClientRect().top < window.innerHeight && mainButton.getBoundingClientRect().bottom > 0
        : false;

      // Show sticky CTA only when:
      // 1. Scrolled past threshold (200px)
      // 2. Main CTA is NOT in viewport
      // 3. Footer is NOT visible
      if (scrollPosition > 200 && !mainButtonVisible && !footerVisible) {
        this.showStickyBar();
      } else {
        this.hideStickyBar();
      }
    }
    
    showStickyBar() {
      this.element.style.display = 'block';
      this.element.classList.add('sticky-cta-bar--visible');
      this.element.setAttribute('aria-hidden', 'false');
      document.body.classList.add('sticky-cta-active');
    }
    
    hideStickyBar() {
      this.element.classList.remove('sticky-cta-bar--visible');
      this.element.setAttribute('aria-hidden', 'true');
      document.body.classList.remove('sticky-cta-active');
      // Delay hiding to allow transition
      setTimeout(() => {
        if (!this.element.classList.contains('sticky-cta-bar--visible')) {
          this.element.style.display = 'none';
        }
      }, 250);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const stickyBar = document.querySelector('[data-sticky-cta]');
    if (stickyBar && window.innerWidth < 750) {
      new StickyCTABar(stickyBar);
    }
  });
</script>

{%- endif -%}

{% schema %}
{
  "name": "Barra CTA Sticky Mobile",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "checkbox",
      "id": "enable_sticky_cta",
      "label": "Activar barra sticky",
      "default": true,
      "info": "Muestra botones fijos de compra en móvil cuando el CTA principal está fuera de vista"
    },
    {
      "type": "checkbox",
      "id": "show_benefits",
      "label": "Mostrar beneficios inline",
      "default": true,
      "info": "Muestra beneficios cortos (Envío / Contraentrega) arriba del botón"
    },
    {
      "type": "text",
      "id": "benefit_1_text",
      "label": "Beneficio 1",
      "default": "Envío Gratis"
    },
    {
      "type": "text",
      "id": "benefit_2_text",
      "label": "Beneficio 2",
      "default": "Pago Contraentrega"
    },
    {
      "type": "text",
      "id": "buy_button_text",
      "label": "Texto botón comprar",
      "default": "Comprar ahora"
    },
    {
      "type": "text",
      "id": "whatsapp_phone",
      "label": "Número de WhatsApp",
      "default": "+573008602789",
      "info": "Número de WhatsApp con código de país (ejemplo: +573008602789)"
    },
    {
      "type": "text",
      "id": "whatsapp_button_text",
      "label": "Texto botón WhatsApp",
      "default": "WhatsApp"
    }
  ],
  "presets": [
    {
      "name": "Barra CTA Sticky Mobile"
    }
  ]
}
{% endschema %}
