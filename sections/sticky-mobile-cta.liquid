{%- if section.settings.enable_sticky_cta and product -%}
<div 
  class="sticky-cta-bar" 
  data-sticky-cta
  role="region"
  aria-label="Botones de compra rápida"
>
  <div class="sticky-cta-bar__container">
    <div class="sticky-cta-bar__price" data-sticky-price>
      {%- if product.selected_or_first_available_variant.compare_at_price > product.selected_or_first_available_variant.price -%}
        <span class="sticky-cta-bar__price-sale">{{ product.selected_or_first_available_variant.price | money }}</span>
        <span class="sticky-cta-bar__price-compare">{{ product.selected_or_first_available_variant.compare_at_price | money }}</span>
      {%- else -%}
        <span class="sticky-cta-bar__price-regular">{{ product.selected_or_first_available_variant.price | money }}</span>
      {%- endif -%}
    </div>
    <button
      type="button"
      class="sticky-cta-bar__button sticky-cta-bar__button--buy"
      data-sticky-buy
      aria-label="Agregar {{ product.title }}"
    >
      <svg class="sticky-cta-bar__icon" width="20" height="20" viewBox="0 0 20 20" fill="none" aria-hidden="true">
        <path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 002-1.61L19 6H5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="9" cy="18" r="1" fill="currentColor"/>
        <circle cx="16" cy="18" r="1" fill="currentColor"/>
      </svg>
      <span class="sticky-cta-bar__text">{{ section.settings.buy_button_text | default: 'Agregar' }}</span>
    </button>
  </div>
</div>

<script>
  class StickyCTABar {
    constructor(element) {
      this.element = element;
      this.buyButton = element.querySelector('[data-sticky-buy]');
      this.productForm = document.querySelector('product-form');
      this.submitButton = document.querySelector('.product-form__submit[id^="ProductSubmitButton-"]') ||
                          document.querySelector('[id^="ProductSubmitButton-"]') ||
                          document.querySelector('[name="add"]');
      this.priceContainer = element.querySelector('[data-sticky-price]');
      this.handleVariantChange = this.handleVariantChange.bind(this);
      
      this.init();
    }

    init() {
      // Show/hide based on scroll position
      this.handleScroll();
      window.addEventListener('scroll', () => this.handleScroll(), { passive: true });
      
      // Handle buy button click
      if (this.buyButton && this.submitButton) {
        this.buyButton.addEventListener('click', () => {
          this.submitButton.click();
        });
      }

      document.addEventListener('variant:change', this.handleVariantChange);
      window.addEventListener('pagehide', () => this.destroy());
    }

    destroy() {
      document.removeEventListener('variant:change', this.handleVariantChange);
    }

    handleVariantChange(event) {
      if (!event.detail || !event.detail.variant || !this.priceContainer) {
        return;
      }

      const { price, compare_at_price: compareAtPrice } = event.detail.variant;
      this.priceContainer.innerHTML = '';

      if (compareAtPrice && compareAtPrice > price) {
        const salePriceSpan = document.createElement('span');
        salePriceSpan.className = 'sticky-cta-bar__price-sale';
        salePriceSpan.textContent = this.formatMoney(price);

        const comparePriceSpan = document.createElement('span');
        comparePriceSpan.className = 'sticky-cta-bar__price-compare';
        comparePriceSpan.textContent = this.formatMoney(compareAtPrice);

        this.priceContainer.appendChild(salePriceSpan);
        this.priceContainer.appendChild(comparePriceSpan);
      } else {
        const regularPriceSpan = document.createElement('span');
        regularPriceSpan.className = 'sticky-cta-bar__price-regular';
        regularPriceSpan.textContent = this.formatMoney(price);

        this.priceContainer.appendChild(regularPriceSpan);
      }
    }

    formatMoney(priceValue) {
      if (typeof priceValue === 'number') {
        if (typeof Shopify !== 'undefined' && typeof Shopify.formatMoney === 'function') {
          return Shopify.formatMoney(priceValue);
        }

        const currency = (typeof Shopify !== 'undefined' && Shopify.currency && Shopify.currency.active)
          ? Shopify.currency.active
          : 'COP';
        const locale = 'es-CO';

        return new Intl.NumberFormat(locale, {
          style: 'currency',
          currency: currency,
          minimumFractionDigits: 0,
          maximumFractionDigits: 0
        }).format(priceValue / 100);
      }

      return priceValue;
    }

    handleScroll() {
      const scrollPosition = window.scrollY;
      const mainButton = this.submitButton;
      const footer = document.querySelector('footer');
      const footerRect = footer ? footer.getBoundingClientRect() : null;
      const footerVisible = footerRect ? footerRect.top < window.innerHeight : false;
      const mainButtonVisible = mainButton
        ? mainButton.getBoundingClientRect().top < window.innerHeight && mainButton.getBoundingClientRect().bottom > 0
        : false;

      if (footerVisible || (mainButton && mainButtonVisible) || scrollPosition <= 200) {
        this.element.classList.remove('sticky-cta-bar--visible');
        return;
      }

      this.element.classList.add('sticky-cta-bar--visible');
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const stickyBar = document.querySelector('[data-sticky-cta]');
    if (stickyBar && window.innerWidth < 750) {
      new StickyCTABar(stickyBar);
    }
  });
</script>

{%- endif -%}

{% schema %}
{
  "name": "Barra CTA Sticky Mobile",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "checkbox",
      "id": "enable_sticky_cta",
      "label": "Activar barra sticky",
      "default": true,
      "info": "Muestra botones fijos de compra y WhatsApp en móvil"
    },
    {
      "type": "text",
      "id": "buy_button_text",
      "label": "Texto botón comprar",
      "default": "Comprar ahora"
    },
    {
      "type": "text",
      "id": "whatsapp_phone",
      "label": "Número de WhatsApp",
      "default": "+573008602789",
      "info": "Número de WhatsApp con código de país (ejemplo: +573008602789)"
    },
    {
      "type": "text",
      "id": "whatsapp_button_text",
      "label": "Texto botón WhatsApp",
      "default": "WhatsApp"
    }
  ],
  "presets": [
    {
      "name": "Barra CTA Sticky Mobile"
    }
  ]
}
{% endschema %}
