{% comment %}
  Urgency Elements Section
  Elementos de urgencia y confianza para p√°ginas de producto (CRO optimizado)
  
  ACTUALIZADO: Solo muestra datos reales del inventario de Shopify.
  Los contadores de "personas viendo" han sido eliminados porque son datos ficticios.
{% endcomment %}

{%- liquid
  assign current_variant = product.selected_or_first_available_variant
  assign inventory_qty = current_variant.inventory_quantity
  assign inventory_managed = current_variant.inventory_management == 'shopify'
  assign low_stock_threshold = section.settings.stock_threshold | default: 15
-%}

<div class="urgency-elements">
  {% if section.settings.show_stock_counter and inventory_managed %}
    {%- if inventory_qty != blank and inventory_qty > 0 and inventory_qty <= low_stock_threshold -%}
    <div class="urgency-element urgency-stock urgency-stock--low">
      <div class="urgency-icon">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
          <path d="M10 2L2 7L10 12L18 7L10 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M2 12L10 17L18 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <div class="urgency-content">
        <span class="urgency-label">Stock limitado:</span>
        <span class="urgency-value stock-counter" data-stock="{{ inventory_qty }}">
          {%- if section.settings.show_exact_stock -%}
            ¬°Solo quedan {{ inventory_qty }} unidades!
          {%- else -%}
            ¬°√öltimas unidades disponibles!
          {%- endif -%}
        </span>
      </div>
    </div>
    {%- elsif inventory_qty != blank and inventory_qty > low_stock_threshold -%}
    <div class="urgency-element urgency-stock urgency-stock--available">
      <div class="urgency-icon">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
          <path d="M16.667 5L7.5 14.167L3.333 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <div class="urgency-content">
        <span class="urgency-value">Disponible para env√≠o inmediato</span>
      </div>
    </div>
    {%- elsif inventory_qty != blank and inventory_qty <= 0 -%}
    <div class="urgency-element urgency-stock urgency-stock--out">
      <div class="urgency-icon">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
          <circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="2"/>
          <path d="M6 6l8 8M14 6l-8 8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <div class="urgency-content">
        <span class="urgency-value">Agotado temporalmente</span>
      </div>
    </div>
    {%- endif -%}
  {% endif %}

  {%- comment -%}
    ELIMINADO: Contador de "personas viendo este producto"
    Raz√≥n: Mostraba n√∫meros aleatorios/ficticios que da√±an la confianza del cliente.
    
    Si necesita mostrar visualizaciones reales, integre Google Analytics 
    o un servicio de tracking de visitantes real.
  {%- endcomment -%}

  {% if section.settings.show_countdown and section.settings.countdown_end_date != blank %}
    <div class="urgency-element urgency-countdown">
      <div class="urgency-icon">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
          <circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="2"/>
          <path d="M10 6V10L13 13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <div class="urgency-content">
        <span class="urgency-label">Oferta termina en:</span>
        <div class="countdown-timer" data-end-date="{{ section.settings.countdown_end_date }}">
          <span class="countdown-unit">
            <span class="countdown-value" data-hours>00</span>
            <span class="countdown-label">h</span>
          </span>
          <span class="countdown-separator">:</span>
          <span class="countdown-unit">
            <span class="countdown-value" data-minutes>00</span>
            <span class="countdown-label">m</span>
          </span>
          <span class="countdown-separator">:</span>
          <span class="countdown-unit">
            <span class="countdown-value" data-seconds>00</span>
            <span class="countdown-label">s</span>
          </span>
        </div>
      </div>
    </div>
  {% endif %}

  {% if section.settings.show_delivery_estimate %}
    <div class="urgency-element urgency-delivery">
      <div class="urgency-icon">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
          <path d="M1 1H4L6.68 13.39C6.77 13.83 7.17 14.14 7.62 14.14H16.38C16.83 14.14 17.23 13.83 17.32 13.39L19 6H5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <circle cx="8" cy="18" r="1" fill="currentColor"/>
          <circle cx="16" cy="18" r="1" fill="currentColor"/>
        </svg>
      </div>
      <div class="urgency-content">
        <span class="urgency-value">{{ section.settings.delivery_message | default: 'Env√≠o en 2-3 d√≠as h√°biles' }}</span>
      </div>
    </div>
  {% endif %}
</div>

<script>
// Countdown timer - Solo si hay una fecha real configurada
function initCountdown() {
  const countdownEl = document.querySelector('.countdown-timer');
  if (!countdownEl) return;
  
  const endDate = new Date(countdownEl.dataset.endDate);
  if (!endDate || isNaN(endDate.getTime())) return;
  
  function updateCountdown() {
    const now = new Date();
    const distance = endDate - now;
    
    if (distance < 0) {
      countdownEl.innerHTML = '<span class="urgency-value">¬°Oferta terminada!</span>';
      return;
    }
    
    const hours = Math.floor(distance / (1000 * 60 * 60));
    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
    
    const hoursEl = countdownEl.querySelector('[data-hours]');
    const minutesEl = countdownEl.querySelector('[data-minutes]');
    const secondsEl = countdownEl.querySelector('[data-seconds]');
    
    if (hoursEl) hoursEl.textContent = String(hours).padStart(2, '0');
    if (minutesEl) minutesEl.textContent = String(minutes).padStart(2, '0');
    if (secondsEl) secondsEl.textContent = String(seconds).padStart(2, '0');
  }
  
  updateCountdown();
  setInterval(updateCountdown, 1000);
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initCountdown);
} else {
  initCountdown();
}
</script>

<style>
  .urgency-stock--low {
    background: linear-gradient(135deg, #fff7ed 0%, #fef3c7 100%);
    border-color: #fbbf24;
    color: #92400e;
  }
  
  .urgency-stock--available {
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    border-color: #22c55e;
    color: #166534;
  }
  
  .urgency-stock--out {
    background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
    border-color: #ef4444;
    color: #991b1b;
  }
</style>

{% schema %}
{
  "name": "Elementos de Urgencia",
  "tag": "section",
  "class": "section-urgency",
  "settings": [
    {
      "type": "header",
      "content": "Indicador de Stock (Datos Reales)"
    },
    {
      "type": "checkbox",
      "id": "show_stock_counter",
      "label": "Mostrar indicador de stock",
      "default": true,
      "info": "Muestra el estado real del inventario de Shopify"
    },
    {
      "type": "range",
      "id": "stock_threshold",
      "min": 1,
      "max": 50,
      "step": 1,
      "label": "Umbral de stock bajo",
      "default": 15,
      "info": "Cuando el inventario est√° por debajo de este n√∫mero, se muestra como 'Stock limitado'"
    },
    {
      "type": "checkbox",
      "id": "show_exact_stock",
      "label": "Mostrar cantidad exacta",
      "default": true,
      "info": "Muestra '¬°Solo quedan X unidades!' en lugar de solo '√öltimas unidades'"
    },
    {
      "type": "header",
      "content": "Temporizador de Oferta"
    },
    {
      "type": "checkbox",
      "id": "show_countdown",
      "label": "Mostrar temporizador de oferta",
      "default": false,
      "info": "‚ö†Ô∏è Solo use si tiene una promoci√≥n REAL con fecha de vencimiento. Countdowns falsos da√±an la confianza del cliente"
    },
    {
      "type": "text",
      "id": "countdown_end_date",
      "label": "Fecha de fin de oferta",
      "info": "Formato: YYYY-MM-DD HH:MM:SS (ej: 2024-12-31 23:59:59)"
    },
    {
      "type": "header",
      "content": "Estimado de Entrega"
    },
    {
      "type": "checkbox",
      "id": "show_delivery_estimate",
      "label": "Mostrar estimado de entrega",
      "default": true
    },
    {
      "type": "text",
      "id": "delivery_message",
      "label": "Mensaje de entrega",
      "default": "üöö Env√≠o 2‚Äì5 d√≠as h√°biles | üí≥ Pago contra entrega disponible",
      "info": "Configure un mensaje de entrega realista para su negocio"
    }
  ],
  "presets": [
    {
      "name": "Elementos de Urgencia"
    }
  ]
}
{% endschema %}
