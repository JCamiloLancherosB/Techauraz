{% comment %}
  DEPRECATED - Use 'card-product' snippet instead
  
  This snippet is deprecated as part of the Dawn template normalization.
  All product card rendering should use the canonical Dawn snippet:
  
  {% render 'card-product', card_product: product %}
  
  The 'card-product' snippet (snippets/card-product.liquid) is the single 
  source of truth for product card rendering across the theme.
  
  Migration Notes:
  - The 'card-product' snippet has different parameters than this snippet.
  - 'show_badges': card-product has built-in badge logic (OFERTA, Nuevo, Agotado)
  - 'cta_text': card-product uses localized "Ver todos los detalles" and quick-add buttons
  - For equivalent functionality, use card-product's built-in features instead.
  
  This file is kept for reference but should not be used in new development.
  
  ---
  Previous documentation (for reference):
  
  Conversion-Optimized Product Card
  
  Accepts:
  - product: {Object} Product object
  - show_badges: {Boolean} Show badges (default: true)
  - cta_text: {String} CTA text (default: "Ver producto")
{% endcomment %}

{%- liquid
  assign show_badges = show_badges | default: true
  assign cta_text = cta_text | default: 'Ver producto'
  
  # Calculate discount percentage if on sale - only when compare_at_price > price
  assign on_sale = false
  assign discount_percent = 0
  if product.compare_at_price and product.compare_at_price > product.price
    assign on_sale = true
    assign discount = product.compare_at_price | minus: product.price
    assign discount_percent = discount | times: 100 | divided_by: product.compare_at_price | round
  endif
  
  # Check if product is new based on tags (case-insensitive check for "nuevo")
  assign is_new = false
  assign tags_lower = product.tags | map: 'downcase'
  if tags_lower contains 'nuevo'
    assign is_new = true
  endif
  
  # Check stock level
  assign in_stock = true
  if product.available == false
    assign in_stock = false
  endif
-%}

<div class="ta-conv-product-card">
  <a href="{{ product.url }}" class="ta-conv-product-card__link">
    <span class="visually-hidden">{{ product.title | escape }}</span>
  </a>
  
  <div class="ta-conv-product-card__image">
    {%- if product.featured_image -%}
      <img 
        src="{{ product.featured_image | image_url: width: 600 }}"
        srcset="{{ product.featured_image | image_url: width: 300 }} 300w,
                {{ product.featured_image | image_url: width: 600 }} 600w"
        sizes="(min-width: 990px) 25vw, (min-width: 750px) 33vw, 50vw"
        alt="{{ product.featured_image.alt | escape | default: product.title | escape }}"
        loading="lazy"
        width="600"
        height="600">
    {%- else -%}
      {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
    {%- endif -%}
    
    {%- if show_badges -%}
      <div class="ta-conv-product-card__badges">
        {%- comment -%} Priority: OFERTA > NUEVO > Agotado - Max 1 badge {%- endcomment -%}
        {%- if on_sale and discount_percent > 0 -%}
          <span class="ta-conv-badge ta-conv-badge--sale">-{{ discount_percent }}%</span>
        {%- elsif is_new -%}
          <span class="ta-conv-badge ta-conv-badge--new">Nuevo</span>
        {%- elsif in_stock == false -%}
          <span class="ta-conv-badge ta-conv-badge--sold-out">Agotado</span>
        {%- endif -%}
      </div>
    {%- endif -%}
  </div>
  
  <div class="ta-conv-product-card__content">
    <h3 class="ta-conv-product-card__title">{{ product.title }}</h3>
    
    <div class="ta-conv-product-card__price">
      <span class="ta-conv-product-card__price-current">
        {{ product.price | money }}
      </span>
      {%- if on_sale -%}
        <span class="ta-conv-product-card__price-original">
          {{ product.compare_at_price | money }}
        </span>
      {%- endif -%}
    </div>
    
    {%- if in_stock -%}
      <a href="{{ product.url }}" class="ta-conv-product-card__cta">
        {{ cta_text }}
      </a>
    {%- else -%}
      <button class="ta-conv-product-card__cta" disabled>
        Agotado
      </button>
    {%- endif -%}
  </div>
</div>
