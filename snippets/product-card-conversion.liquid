{% comment %}
  Conversion-Optimized Product Card
  
  Accepts:
  - product: {Object} Product object
  - show_badges: {Boolean} Show badges (default: true)
  - cta_text: {String} CTA text (default: "Ver producto")
  
  Usage:
  {% render 'product-card-conversion', 
    product: product,
    show_badges: true,
    cta_text: 'Ver producto'
  %}
{% endcomment %}

{%- liquid
  assign show_badges = show_badges | default: true
  assign cta_text = cta_text | default: 'Ver producto'
  
  # Calculate discount percentage if on sale - only when compare_at_price > price
  assign on_sale = false
  assign discount_percent = 0
  if product.compare_at_price and product.compare_at_price > product.price
    assign on_sale = true
    assign discount = product.compare_at_price | minus: product.price
    assign discount_percent = discount | times: 100 | divided_by: product.compare_at_price | round
  endif
  
  # Check if product is new based on tags (case-insensitive check for "nuevo")
  assign is_new = false
  assign tags_lower = product.tags | map: 'downcase' | join: ','
  if tags_lower contains 'nuevo'
    assign is_new = true
  endif
  
  # Check stock level
  assign in_stock = true
  if product.available == false
    assign in_stock = false
  endif
-%}

<div class="ta-conv-product-card">
  <a href="{{ product.url }}" class="ta-conv-product-card__link" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;">
    <span class="visually-hidden">{{ product.title | escape }}</span>
  </a>
  
  <div class="ta-conv-product-card__image">
    {%- if product.featured_image -%}
      <img 
        src="{{ product.featured_image | image_url: width: 600 }}"
        srcset="{{ product.featured_image | image_url: width: 300 }} 300w,
                {{ product.featured_image | image_url: width: 600 }} 600w"
        sizes="(min-width: 990px) 25vw, (min-width: 750px) 33vw, 50vw"
        alt="{{ product.featured_image.alt | escape | default: product.title | escape }}"
        loading="lazy"
        width="600"
        height="600">
    {%- else -%}
      {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
    {%- endif -%}
    
    {%- if show_badges -%}
      <div class="ta-conv-product-card__badges">
        {%- comment -%} Priority: OFERTA > NUEVO > Agotado - Max 1 badge {%- endcomment -%}
        {%- if on_sale and discount_percent > 0 -%}
          <span class="ta-conv-badge ta-conv-badge--sale">-{{ discount_percent }}%</span>
        {%- elsif is_new -%}
          <span class="ta-conv-badge ta-conv-badge--new">Nuevo</span>
        {%- elsif in_stock == false -%}
          <span class="ta-conv-badge ta-conv-badge--sold-out">Agotado</span>
        {%- endif -%}
      </div>
    {%- endif -%}
  </div>
  
  <div class="ta-conv-product-card__content" style="position: relative; z-index: 2;">
    <h3 class="ta-conv-product-card__title">{{ product.title }}</h3>
    
    <div class="ta-conv-product-card__price">
      <span class="ta-conv-product-card__price-current">
        {{ product.price | money }}
      </span>
      {%- if on_sale -%}
        <span class="ta-conv-product-card__price-original">
          {{ product.compare_at_price | money }}
        </span>
      {%- endif -%}
    </div>
    
    {%- if in_stock -%}
      <a href="{{ product.url }}" class="ta-conv-product-card__cta" style="position: relative; z-index: 3;">
        {{ cta_text }}
      </a>
    {%- else -%}
      <button class="ta-conv-product-card__cta" disabled style="opacity: 0.6; cursor: not-allowed; position: relative; z-index: 3;">
        Agotado
      </button>
    {%- endif -%}
  </div>
</div>

<style>
  /* Badge styles for conversion product cards */
  .ta-conv-badge--sale {
    background: rgba(239, 68, 68, 0.9);
    color: #ffffff;
    font-weight: 700;
  }
  
  .ta-conv-badge--sold-out {
    background: rgba(107, 114, 128, 0.9);
    color: #ffffff;
    font-weight: 600;
  }
</style>
