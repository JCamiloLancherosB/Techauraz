{% comment %}
  Renders a sticky mobile CTA bar for product pages
  
  Accepts:
  - product: {Object} Product object
  - section_id: {String} Section ID for form targeting
  
  Usage:
  {% render 'sticky-mobile-cta', product: product, section_id: section.id %}
{% endcomment %}

{%- if product != blank -%}
  <div class="sticky-mobile-cta" id="sticky-mobile-cta" style="display: none;">
    <div class="sticky-mobile-cta__container">
      <div class="sticky-mobile-cta__info">
        <div class="sticky-mobile-cta__price">
          {%- if product.selected_or_first_available_variant.compare_at_price > product.selected_or_first_available_variant.price -%}
            <span class="sticky-mobile-cta__price-sale">
              {{ product.selected_or_first_available_variant.price | money }}
            </span>
            <span class="sticky-mobile-cta__price-compare">
              {{ product.selected_or_first_available_variant.compare_at_price | money }}
            </span>
          {%- else -%}
            <span class="sticky-mobile-cta__price-regular">
              {{ product.selected_or_first_available_variant.price | money }}
            </span>
          {%- endif -%}
        </div>
        <div class="sticky-mobile-cta__delivery">
          ðŸšš Pago contra entrega
        </div>
      </div>
      
      <button 
        type="button" 
        class="sticky-mobile-cta__button"
        onclick="document.getElementById('ProductSubmitButton-{{ section_id }}').click()"
        {%- if product.selected_or_first_available_variant.available == false -%}
          disabled
        {%- endif -%}
      >
        {%- if product.selected_or_first_available_variant.available == false -%}
          Agotado
        {%- else -%}
          Comprar ahora
        {%- endif -%}
      </button>
    </div>
  </div>

  <style>
    /* Sticky Mobile CTA Bar */
    .sticky-mobile-cta {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(180deg, rgba(15, 23, 42, 0.95) 0%, rgba(15, 23, 42, 0.98) 100%);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-top: 2px solid rgba(251, 191, 36, 0.3);
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
      z-index: 999;
      padding: 0.8rem 1rem;
      transition: transform 0.3s ease, opacity 0.3s ease;
      animation: slideInUp 0.3s ease;
    }

    @keyframes slideInUp {
      from {
        transform: translateY(100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .sticky-mobile-cta__container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      max-width: 100%;
    }

    .sticky-mobile-cta__info {
      flex: 1;
      min-width: 0;
    }

    .sticky-mobile-cta__price {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.6rem;
      font-weight: 700;
      line-height: 1.2;
      margin-bottom: 0.2rem;
    }

    .sticky-mobile-cta__price-sale {
      color: #f59e0b;
    }

    .sticky-mobile-cta__price-compare {
      color: #64748b;
      text-decoration: line-through;
      font-size: 1.3rem;
      font-weight: 500;
    }

    .sticky-mobile-cta__price-regular {
      color: #fbbf24;
    }

    .sticky-mobile-cta__delivery {
      font-size: 1.2rem;
      color: #cbd5e1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .sticky-mobile-cta__button {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: #0f172a;
      font-weight: 700;
      font-size: 1.4rem;
      padding: 1.2rem 2rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
      min-height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sticky-mobile-cta__button:hover:not(:disabled) {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(245, 158, 11, 0.5);
    }

    .sticky-mobile-cta__button:active:not(:disabled) {
      transform: translateY(0);
    }

    .sticky-mobile-cta__button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: linear-gradient(135deg, #64748b 0%, #475569 100%);
    }

    /* Hide on desktop */
    @media screen and (min-width: 750px) {
      .sticky-mobile-cta {
        display: none !important;
      }
    }

    /* Adjust for very small screens */
    @media screen and (max-width: 360px) {
      .sticky-mobile-cta__button {
        padding: 1rem 1.5rem;
        font-size: 1.3rem;
      }
      
      .sticky-mobile-cta__price {
        font-size: 1.4rem;
      }
      
      .sticky-mobile-cta__delivery {
        font-size: 1.1rem;
      }
    }
  </style>

  <script>
    // Show sticky CTA when scrolling past the main buy button
    (function() {
      const stickyCta = document.getElementById('sticky-mobile-cta');
      const mainButton = document.getElementById('ProductSubmitButton-{{ section_id }}');
      
      if (!stickyCta || !mainButton) return;
      
      // Only activate on mobile
      if (window.innerWidth >= 750) return;
      
      let lastScrollY = window.scrollY;
      let ticking = false;
      
      function updateStickyVisibility() {
        const mainButtonRect = mainButton.getBoundingClientRect();
        const isMainButtonVisible = mainButtonRect.top < window.innerHeight && mainButtonRect.bottom > 0;
        
        if (window.scrollY > 200 && !isMainButtonVisible) {
          stickyCta.style.display = 'block';
        } else {
          stickyCta.style.display = 'none';
        }
        
        ticking = false;
      }
      
      function onScroll() {
        lastScrollY = window.scrollY;
        if (!ticking) {
          window.requestAnimationFrame(updateStickyVisibility);
          ticking = true;
        }
      }
      
      // Initial check
      updateStickyVisibility();
      
      // Listen to scroll
      window.addEventListener('scroll', onScroll, { passive: true });
      
      // Update on resize
      window.addEventListener('resize', function() {
        if (window.innerWidth >= 750) {
          stickyCta.style.display = 'none';
        } else {
          updateStickyVisibility();
        }
      });
      
      // Update when variant changes
      document.addEventListener('variant:change', function(event) {
        if (event.detail && event.detail.variant) {
          // Update price
          const priceContainer = stickyCta.querySelector('.sticky-mobile-cta__price');
          if (priceContainer && event.detail.variant.price) {
            const price = event.detail.variant.price;
            const comparePrice = event.detail.variant.compare_at_price;
            
            if (comparePrice && comparePrice > price) {
              priceContainer.innerHTML = `
                <span class="sticky-mobile-cta__price-sale">${formatMoney(price)}</span>
                <span class="sticky-mobile-cta__price-compare">${formatMoney(comparePrice)}</span>
              `;
            } else {
              priceContainer.innerHTML = `
                <span class="sticky-mobile-cta__price-regular">${formatMoney(price)}</span>
              `;
            }
          }
          
          // Update button state
          const button = stickyCta.querySelector('.sticky-mobile-cta__button');
          if (button) {
            if (event.detail.variant.available) {
              button.disabled = false;
              button.textContent = 'Comprar ahora';
            } else {
              button.disabled = true;
              button.textContent = 'Agotado';
            }
          }
        }
      });
      
      // Simple money formatter
      function formatMoney(cents) {
        return new Intl.NumberFormat('es-CO', {
          style: 'currency',
          currency: 'COP',
          minimumFractionDigits: 0,
          maximumFractionDigits: 0
        }).format(cents / 100);
      }
    })();
  </script>
{%- endif -%}
