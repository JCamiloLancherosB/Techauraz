{% comment %}
  Renders a sticky mobile CTA bar for product pages
  
  Accepts:
  - product: {Object} Product object
  - section_id: {String} Section ID for form targeting
  
  Usage:
  {% render 'sticky-mobile-cta', product: product, section_id: section.id %}
{% endcomment %}

{%- if product != blank -%}
  <div class="sticky-mobile-cta" id="sticky-mobile-cta">
    <div class="sticky-mobile-cta__container">
      <div class="sticky-mobile-cta__info">
        <div class="sticky-mobile-cta__price">
          {%- if product.selected_or_first_available_variant.compare_at_price > product.selected_or_first_available_variant.price -%}
            <span class="sticky-mobile-cta__price-sale">
              {{ product.selected_or_first_available_variant.price | money }}
            </span>
            <span class="sticky-mobile-cta__price-compare">
              {{ product.selected_or_first_available_variant.compare_at_price | money }}
            </span>
          {%- else -%}
            <span class="sticky-mobile-cta__price-regular">
              {{ product.selected_or_first_available_variant.price | money }}
            </span>
          {%- endif -%}
        </div>
        <div class="sticky-mobile-cta__delivery">
          ðŸšš Pago contra entrega
        </div>
      </div>
      
      <button 
        type="button" 
        class="sticky-mobile-cta__button"
        data-sticky-cta-trigger="{{ section_id }}"
        {%- if product.selected_or_first_available_variant.available == false -%}
          disabled
        {%- endif -%}
      >
        {%- if product.selected_or_first_available_variant.available == false -%}
          Agotado
        {%- else -%}
          Comprar ahora
        {%- endif -%}
      </button>
    </div>
  </div>

  <script>
    // Show sticky CTA when scrolling past the main buy button
    (function() {
      const stickyCta = document.getElementById('sticky-mobile-cta');
      const mainButton = document.getElementById('ProductSubmitButton-{{ section_id }}');
      const stickyButton = document.querySelector('[data-sticky-cta-trigger="{{ section_id }}"]');
      
      if (!stickyCta || !mainButton) return;
      
      // Handle sticky button click with error handling and fallback selector
      if (stickyButton) {
        stickyButton.addEventListener('click', function() {
          // Try primary selector first
          let submitButton = mainButton;
          
          // Fallback: try alternative selectors if primary not found
          if (!submitButton || typeof submitButton.click !== 'function') {
            submitButton = document.querySelector('.product-form__submit');
          }
          if (!submitButton || typeof submitButton.click !== 'function') {
            submitButton = document.querySelector('[name="add"]');
          }
          
          if (submitButton && typeof submitButton.click === 'function') {
            submitButton.click();
          } else {
            console.error('Product submit button not found. Tried multiple selectors.');
          }
        });
      }
      
      // Only activate on mobile
      if (window.innerWidth >= 750) return;
      
      let lastScrollY = window.scrollY;
      let ticking = false;
      
      function updateStickyVisibility() {
        const mainButtonRect = mainButton.getBoundingClientRect();
        const isMainButtonVisible = mainButtonRect.top < window.innerHeight && mainButtonRect.bottom > 0;
        
        if (window.scrollY > 200 && !isMainButtonVisible) {
          stickyCta.style.display = 'block';
        } else {
          stickyCta.style.display = 'none';
        }
        
        ticking = false;
      }
      
      function onScroll() {
        lastScrollY = window.scrollY;
        if (!ticking) {
          window.requestAnimationFrame(updateStickyVisibility);
          ticking = true;
        }
      }
      
      // Initial check
      updateStickyVisibility();
      
      // Listen to scroll
      window.addEventListener('scroll', onScroll, { passive: true });
      
      // Update on resize
      window.addEventListener('resize', function() {
        if (window.innerWidth >= 750) {
          stickyCta.style.display = 'none';
        } else {
          updateStickyVisibility();
        }
      });
      
      // Update when variant changes
      // Expected event.detail format: { variant: { id, price, compare_at_price, available } }
      // This event is typically dispatched by product-form.js or variant picker components
      document.addEventListener('variant:change', function(event) {
        if (event.detail && event.detail.variant) {
          // Update price - using safe DOM manipulation to prevent XSS
          const priceContainer = stickyCta.querySelector('.sticky-mobile-cta__price');
          if (priceContainer && event.detail.variant.price) {
            const price = event.detail.variant.price;
            const comparePrice = event.detail.variant.compare_at_price;
            
            // Clear existing content
            priceContainer.innerHTML = '';
            
            if (comparePrice && comparePrice > price) {
              // Create sale price elements
              const salePriceSpan = document.createElement('span');
              salePriceSpan.className = 'sticky-mobile-cta__price-sale';
              salePriceSpan.textContent = formatMoney(price);
              
              const comparePriceSpan = document.createElement('span');
              comparePriceSpan.className = 'sticky-mobile-cta__price-compare';
              comparePriceSpan.textContent = formatMoney(comparePrice);
              
              priceContainer.appendChild(salePriceSpan);
              priceContainer.appendChild(comparePriceSpan);
            } else {
              // Create regular price element
              const regularPriceSpan = document.createElement('span');
              regularPriceSpan.className = 'sticky-mobile-cta__price-regular';
              regularPriceSpan.textContent = formatMoney(price);
              
              priceContainer.appendChild(regularPriceSpan);
            }
          }
          
          // Update button state
          const button = stickyCta.querySelector('.sticky-mobile-cta__button');
          if (button) {
            if (event.detail.variant.available) {
              button.disabled = false;
              button.textContent = 'Comprar ahora';
            } else {
              button.disabled = true;
              button.textContent = 'Agotado';
            }
          }
        }
      });
      
      // Money formatter
      // Note: Shopify prices may be in cents or already formatted depending on store configuration
      // Uses store's currency settings from Shopify.currency or defaults to COP
      function formatMoney(priceValue) {
        // Get currency from Shopify settings if available, otherwise default to COP
        const currency = (typeof Shopify !== 'undefined' && Shopify.currency && Shopify.currency.active) 
          ? Shopify.currency.active 
          : 'COP';
        const locale = 'es-CO'; // Could be made configurable via theme settings
        
        // Check if price is a number (cents format)
        if (typeof priceValue === 'number') {
          return new Intl.NumberFormat(locale, {
            style: 'currency',
            currency: currency,
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
          }).format(priceValue / 100);
        }
        // If already a formatted string, return as-is
        return priceValue;
      }
    })();
  </script>
{%- endif -%}
