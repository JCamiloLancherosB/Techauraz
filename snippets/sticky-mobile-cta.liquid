{% comment %}
  Renders a sticky mobile CTA bar for product pages
  
  Accepts:
  - product: {Object} Product object
  - section_id: {String} Section ID for form targeting
  
  Features:
  - Appears only when primary CTA is out of viewport
  - Does not overlap WhatsApp button or cookie banner
  - Correctly triggers Buy Now vs Add to Cart action
  - Updates with variant changes (price and availability)
  
  Usage:
  {% render 'sticky-mobile-cta', product: product, section_id: section.id %}
{% endcomment %}

{%- if product != blank -%}
  <div class="sticky-mobile-cta" id="sticky-mobile-cta" aria-hidden="true" role="region" aria-label="Compra rÃ¡pida">
    <div class="sticky-mobile-cta__container">
      <div class="sticky-mobile-cta__info">
        <div class="sticky-mobile-cta__price" data-sticky-price>
          {%- if product.selected_or_first_available_variant.compare_at_price > product.selected_or_first_available_variant.price -%}
            <span class="sticky-mobile-cta__price-sale">
              {{ product.selected_or_first_available_variant.price | money }}
            </span>
            <span class="sticky-mobile-cta__price-compare">
              {{ product.selected_or_first_available_variant.compare_at_price | money }}
            </span>
          {%- else -%}
            <span class="sticky-mobile-cta__price-regular">
              {{ product.selected_or_first_available_variant.price | money }}
            </span>
          {%- endif -%}
        </div>
        <div class="sticky-mobile-cta__delivery">
          ðŸšš Pago contra entrega
        </div>
      </div>
      
      <button 
        type="button" 
        class="sticky-mobile-cta__button"
        data-sticky-cta-trigger="{{ section_id }}"
        data-action="buy-now"
        {%- if product.selected_or_first_available_variant.available == false -%}
          disabled
          aria-disabled="true"
        {%- endif -%}
        aria-label="{% if product.selected_or_first_available_variant.available == false %}Producto agotado{% else %}Comprar {{ product.title }} ahora{% endif %}"
      >
        {%- if product.selected_or_first_available_variant.available == false -%}
          Agotado
        {%- else -%}
          Comprar ahora
        {%- endif -%}
      </button>
    </div>
  </div>

  {%- comment -%} 
    Styles have been moved to assets/techauraz-custom-ui.css
    for maintainability and predictable cascade.
  {%- endcomment -%}

  <script>
    /**
     * Sticky Mobile CTA Controller
     * - Shows when primary CTA scrolls out of viewport
     * - Coordinates with WhatsApp and cookie banner
     * - Handles Buy Now vs Add to Cart action intentionally
     * - Updates on variant changes
     */
    (function() {
      const stickyCta = document.getElementById('sticky-mobile-cta');
      if (!stickyCta) return;
      
      // Find primary CTA elements - multiple fallback selectors
      const primaryCtaSelectors = [
        '#ProductSubmitButton-{{ section_id }}',
        '.product-form__submit[id^="ProductSubmitButton-"]',
        '.product-form__submit',
        '.tech-cta-primary .shopify-payment-button__button',
        '.shopify-payment-button__button',
        '[name="add"]'
      ];
      
      let mainButton = null;
      for (const selector of primaryCtaSelectors) {
        mainButton = document.querySelector(selector);
        if (mainButton) break;
      }
      
      const stickyButton = stickyCta.querySelector('[data-sticky-cta-trigger]');
      const priceContainer = stickyCta.querySelector('[data-sticky-price]');
      
      if (!mainButton) {
        console.warn('Sticky CTA: Primary button not found');
        return;
      }
      
      // Determine if this is a Buy Now or Add to Cart action
      const getBuyNowButton = () => {
        return document.querySelector('.shopify-payment-button__button') ||
               document.querySelector('.tech-cta-primary .shopify-payment-button__button');
      };
      
      const getAddToCartButton = () => {
        return document.querySelector('.product-form__submit') ||
               document.querySelector('[name="add"]');
      };
      
      // Handle sticky button click - triggers Buy Now action by default
      if (stickyButton) {
        stickyButton.addEventListener('click', function(e) {
          e.preventDefault();
          
          const action = this.dataset.action || 'buy-now';
          let targetButton;
          
          if (action === 'buy-now') {
            // Try Buy Now (accelerated checkout) first
            targetButton = getBuyNowButton();
            // Fall back to Add to Cart if no Buy Now available
            if (!targetButton) {
              targetButton = getAddToCartButton();
            }
          } else {
            // Add to Cart action
            targetButton = getAddToCartButton();
          }
          
          if (targetButton && typeof targetButton.click === 'function') {
            // Scroll to product form for user context
            const productForm = document.querySelector('product-form, .product-form');
            if (productForm) {
              productForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            // Small delay to allow scroll before triggering action
            setTimeout(() => {
              targetButton.click();
            }, 100);
          } else {
            console.error('Sticky CTA: No valid target button found');
          }
        });
      }
      
      // Only activate visibility logic on mobile
      const isMobile = () => window.innerWidth < 750;
      
      if (!isMobile()) {
        stickyCta.style.display = 'none';
        return;
      }
      
      let ticking = false;
      
      function updateStickyVisibility() {
        if (!isMobile()) {
          hideStickyBar();
          ticking = false;
          return;
        }
        
        const mainButtonRect = mainButton.getBoundingClientRect();
        const isMainButtonInViewport = mainButtonRect.top < window.innerHeight && mainButtonRect.bottom > 0;
        
        // Check if footer is visible (hide sticky when at bottom)
        const footer = document.querySelector('footer');
        const footerRect = footer ? footer.getBoundingClientRect() : null;
        const isFooterVisible = footerRect ? footerRect.top < window.innerHeight : false;
        
        // Show sticky CTA only when:
        // 1. Scrolled past threshold (200px)
        // 2. Main CTA is NOT in viewport
        // 3. Footer is NOT visible
        if (window.scrollY > 200 && !isMainButtonInViewport && !isFooterVisible) {
          showStickyBar();
        } else {
          hideStickyBar();
        }
        
        ticking = false;
      }
      
      function showStickyBar() {
        stickyCta.style.display = 'block';
        stickyCta.classList.add('sticky-mobile-cta--visible');
        stickyCta.setAttribute('aria-hidden', 'false');
        document.body.classList.add('sticky-cta-active');
      }
      
      function hideStickyBar() {
        stickyCta.classList.remove('sticky-mobile-cta--visible');
        stickyCta.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('sticky-cta-active');
        // Delay hiding to allow transition
        setTimeout(() => {
          if (!stickyCta.classList.contains('sticky-mobile-cta--visible')) {
            stickyCta.style.display = 'none';
          }
        }, 250);
      }
      
      function onScroll() {
        if (!ticking) {
          window.requestAnimationFrame(updateStickyVisibility);
          ticking = true;
        }
      }
      
      // Initial check
      updateStickyVisibility();
      
      // Listen to scroll with passive for better performance
      window.addEventListener('scroll', onScroll, { passive: true });
      
      function updatePriceDisplay(price, comparePrice) {
        priceContainer.innerHTML = '';
        
        if (comparePrice && comparePrice > price) {
          const salePriceSpan = document.createElement('span');
          salePriceSpan.className = 'sticky-mobile-cta__price-sale';
          salePriceSpan.textContent = formatMoney(price);
          
          const comparePriceSpan = document.createElement('span');
          comparePriceSpan.className = 'sticky-mobile-cta__price-compare';
          comparePriceSpan.textContent = formatMoney(comparePrice);
          
          priceContainer.appendChild(salePriceSpan);
          priceContainer.appendChild(comparePriceSpan);
        } else {
          const regularPriceSpan = document.createElement('span');
          regularPriceSpan.className = 'sticky-mobile-cta__price-regular';
          regularPriceSpan.textContent = formatMoney(price);
          
          priceContainer.appendChild(regularPriceSpan);
        }
      }
      
      function updateButtonState(isAvailable) {
        if (isAvailable) {
          stickyButton.disabled = false;
          stickyButton.removeAttribute('aria-disabled');
          stickyButton.textContent = 'Comprar ahora';
          stickyButton.setAttribute('aria-label', 'Comprar ahora');
        } else {
          stickyButton.disabled = true;
          stickyButton.setAttribute('aria-disabled', 'true');
          stickyButton.textContent = 'Agotado';
          stickyButton.setAttribute('aria-label', 'Producto agotado');
        }
      }
      
      /**
       * Format price value to currency string
       * Handles both cents (number) and pre-formatted strings
       */
      function formatMoney(priceValue) {
        // Use Shopify's formatter if available
        try {
          if (typeof Shopify !== 'undefined' && typeof Shopify.formatMoney === 'function') {
            return Shopify.formatMoney(priceValue);
          }
        } catch (e) {
          console.warn('Shopify.formatMoney failed, using fallback', e);
        }
        
        // Fallback formatter
        const currency = (typeof Shopify !== 'undefined' && Shopify.currency && Shopify.currency.active) 
          ? Shopify.currency.active 
          : 'COP';
        const locale = 'es-CO';
        
        if (typeof priceValue === 'number') {
          try {
            return new Intl.NumberFormat(locale, {
              style: 'currency',
              currency: currency,
              minimumFractionDigits: 0,
              maximumFractionDigits: 0
            }).format(priceValue / 100);
          } catch (e) {
            return '$' + Math.round(priceValue / 100).toLocaleString();
          }
        }
        
        return priceValue;
      }
      
      // Cleanup function - removes all event listeners
      function cleanup() {
        window.removeEventListener('scroll', onScroll);
        document.removeEventListener('variant:change', variantChangeHandler);
        if (resizeTimeout) {
          clearTimeout(resizeTimeout);
        }
      }
      
      // Store reference for cleanup
      function variantChangeHandler(event) {
        if (!event.detail || !event.detail.variant) return;
        
        const variant = event.detail.variant;
        
        // Update price display
        if (priceContainer && variant.price !== undefined) {
          updatePriceDisplay(variant.price, variant.compare_at_price);
        }
        
        // Update button state and text
        if (stickyButton) {
          updateButtonState(variant.available);
        }
      }
      
      // Listen for variant changes
      document.addEventListener('variant:change', variantChangeHandler);
      
      // Handle resize with debounce
      let resizeTimeout;
      window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          if (!isMobile()) {
            hideStickyBar();
          } else {
            updateStickyVisibility();
          }
        }, 150);
      });
      
      // Cleanup on page hide
      window.addEventListener('pagehide', cleanup);
    })();
  </script>
{%- endif -%}
