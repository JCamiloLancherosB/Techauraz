{% comment %}
  Sticky Add-to-Cart Bar for Mobile Product Pages
  
  Features:
  - Fixed bottom bar appearing only on product pages
  - Shows product thumbnail, truncated title, price, and "Agregar" button
  - Uses Intersection Observer to show when main add-to-cart button scrolls out of view
  - Hides when main button is visible again
  - Syncs quantity with main product form
  
  Usage: {% render 'sticky-add-to-cart', product: product %}
  
  Dependencies:
  - assets/sticky-cart-bar.css
  - assets/sticky-cart-bar.js
{% endcomment %}

{%- if product -%}
<div 
  class="sticky-add-to-cart" 
  id="StickyAddToCart"
  data-sticky-add-to-cart
  data-product-id="{{ product.id }}"
  data-variant-id="{{ product.selected_or_first_available_variant.id }}"
  role="region"
  aria-label="Agregar al carrito - Acceso rÃ¡pido"
  aria-hidden="true"
>
  <div class="sticky-add-to-cart__container">
    {%- comment -%} Product Thumbnail - Clickable to scroll to top {%- endcomment -%}
    <button 
      type="button" 
      class="sticky-add-to-cart__thumbnail"
      data-sticky-thumbnail
      aria-label="Ver producto completo"
    >
      {%- if product.featured_image -%}
        {{ product.featured_image | image_url: width: 120 | image_tag:
          class: 'sticky-add-to-cart__image',
          loading: 'lazy',
          alt: product.title,
          width: 60,
          height: 60
        }}
      {%- else -%}
        <div class="sticky-add-to-cart__image-placeholder">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
            <circle cx="8.5" cy="8.5" r="1.5" fill="currentColor"/>
            <path d="M21 15l-5-5L5 21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      {%- endif -%}
    </button>

    {%- comment -%} Product Info: Title + Price {%- endcomment -%}
    <div class="sticky-add-to-cart__info">
      <h3 class="sticky-add-to-cart__title" title="{{ product.title | escape }}">
        {{ product.title | truncate: 30, '...' }}
      </h3>
      <div class="sticky-add-to-cart__price" data-sticky-price>
        {%- if product.selected_or_first_available_variant.compare_at_price > product.selected_or_first_available_variant.price -%}
          <span class="sticky-add-to-cart__price-sale">
            {{ product.selected_or_first_available_variant.price | money }}
          </span>
          <span class="sticky-add-to-cart__price-compare">
            {{ product.selected_or_first_available_variant.compare_at_price | money }}
          </span>
        {%- else -%}
          <span class="sticky-add-to-cart__price-regular">
            {{ product.selected_or_first_available_variant.price | money }}
          </span>
        {%- endif -%}
      </div>
    </div>

    {%- comment -%} Quantity Selector (hidden by default, syncs with main form) {%- endcomment -%}
    <div class="sticky-add-to-cart__quantity" data-sticky-quantity>
      <button 
        type="button" 
        class="sticky-add-to-cart__qty-btn" 
        data-qty-decrease
        aria-label="Disminuir cantidad"
      >
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
      <span class="sticky-add-to-cart__qty-value" data-qty-value>1</span>
      <button 
        type="button" 
        class="sticky-add-to-cart__qty-btn" 
        data-qty-increase
        aria-label="Aumentar cantidad"
      >
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>

    {%- comment -%} Add to Cart Button {%- endcomment -%}
    <button
      type="button"
      class="sticky-add-to-cart__button"
      data-sticky-add-btn
      {%- if product.selected_or_first_available_variant.available == false -%}
        disabled
        aria-disabled="true"
      {%- endif -%}
      aria-label="{% if product.selected_or_first_available_variant.available %}Agregar {{ product.title | truncate: 20 }} al carrito{% else %}Producto agotado{% endif %}"
    >
      <svg class="sticky-add-to-cart__btn-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M6 6h15l-1.5 9h-12L6 6z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M6 6L5 2H2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="10" cy="20" r="1.5" stroke="currentColor" stroke-width="2"/>
        <circle cx="18" cy="20" r="1.5" stroke="currentColor" stroke-width="2"/>
      </svg>
      <span class="sticky-add-to-cart__btn-text">
        {%- if product.selected_or_first_available_variant.available == false -%}
          Agotado
        {%- else -%}
          Agregar
        {%- endif -%}
      </span>
    </button>
  </div>
</div>

{%- comment -%} Load CSS and JS assets {%- endcomment -%}
{{ 'sticky-cart-bar.css' | asset_url | stylesheet_tag }}
<script src="{{ 'sticky-cart-bar.js' | asset_url }}" defer="defer"></script>
{%- endif -%}
